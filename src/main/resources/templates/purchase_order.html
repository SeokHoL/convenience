<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>êµ¬ë§¤ ë°œì£¼ ê´€ë¦¬</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background-color: #f4f6f9;
    }

    .top-bar {
      background-color: #007bff;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logout-btn {
      background-color: white;
      border: none;
      color: #007bff;
      padding: 5px 15px;
      font-size: 1rem;
      border-radius: 5px;
      text-decoration: none;
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .logout-btn:hover {
      background-color: #e3f2fd;
      color: #0056b3;
      text-decoration: none;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .table {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .table th {
      background-color: #007bff;
      color: white;
    }

    .btn-primary,
    .btn-success {
      border-radius: 20px;
    }

    th, td {
      text-align: center; /* í…ìŠ¤íŠ¸ ë° ì²´í¬ë°•ìŠ¤ ì¤‘ì•™ ì •ë ¬ */
      vertical-align: middle;
    }

    .btn-success-custom {
      background-color: #28a745;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .btn-success-custom:hover {
      background-color: #218838;
    }

    .btn-warning-custom {
      background-color: #ffc107;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .btn-warning-custom:hover {
      background-color: #e0a800;
    }

    /* ëª¨ë‹¬ í¬ê¸° ì¡°ì • */
    .modal-xl {
      max-width: 95%;
    }

    /* ë²„íŠ¼ì„ ë„¤ëª¨ í˜•íƒœë¡œ ë³€ê²½ */
    .btn-lg {
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 1.2rem;
      font-weight: bold;
    }

    /* ìµœì†Œ ë°œì£¼ëŸ‰ì„ 0ìœ¼ë¡œ ë³€ê²½ */
    .order-quantity {
      min: 0 !important;
    }

  </style>
</head>
<body>
<div class="top-bar">
  <span>êµ¬ë§¤ ë°œì£¼ ê´€ë¦¬</span>
  <div>
    <a href="/main" class="text-white text-decoration-none me-3">í™ˆ</a>
    <a href="/logout" class="text-white text-decoration-none">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>

<div class="container mt-4">
  <div class="form-container">
    <h3 class="mb-4">êµ¬ë§¤ ë°œì£¼ ê²€ìƒ‰</h3>
    <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶”ê°€ -->
    <div th:if="${error}" class="alert alert-danger" role="alert">
      <span th:text="${error}"></span>
    </div>
    <form id="searchForm" th:action="@{/purchase_order/search}" method="post">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="branch" class="form-label">ì§€ì </label>
          <select class="form-select" id="branch" name="branch">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ë³¸ì‚¬">ë³¸ì‚¬</option>
            <option value="ì•ˆì–‘">ì•ˆì–‘</option>
            <option value="ì²­ì£¼">ì²­ì£¼</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="orderId" class="form-label">ë°œì£¼ë²ˆí˜¸</label>
          <input type="text" id="orderId" name="orderId" class="form-control" placeholder="ë°œì£¼ë²ˆí˜¸">


        </div>
        <div class="col-md-3">
          <label for="requesterName" class="form-label">ì‚¬ìš©ìëª…</label>
          <input type="text" id="requesterName" name="requesterName" class="form-control" placeholder="ì‚¬ìš©ìëª…">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">ì¡°íšŒ</button>
        </div>
      </div>
    </form>
  </div>

  <div class="text-end mb-3">
    <button class="btn btn-success-custom" data-bs-toggle="modal" data-bs-target="#addPurchaseOrderModal">ì¶”ê°€</button>
    <button class="btn btn-warning-custom" onclick="editSelected()">ìˆ˜ì •</button>
    <button class="btn btn-danger" onclick="deleteSelected()">ì‚­ì œ</button>
  </div>


  <table class="table table-bordered table-hover mt-4">
    <thead>
      <tr>
        <th>ì„ íƒ</th>
        <th>ë°œì£¼ë²ˆí˜¸</th>
        <th>ì§€ì ëª…</th>
        <th>ë°œì£¼ì ID</th>
        <th>ë°œì£¼ì ì´ë¦„</th>
        <th>ìƒíƒœ</th>
        <th>ë“±ë¡ì¼ì</th>
        <th>ìˆ˜ì •ì¼ì</th>
        <th>ìˆ˜ì •ì</th>
      </tr>
      </thead>
    <tbody>
    <tr th:if="${purchaseOrders != null and not #lists.isEmpty(purchaseOrders)}" th:each="order : ${purchaseOrders}">
      <td><input type="checkbox" class="rowCheckbox" th:value="${order.orderId}"></td>
      <td th:text="${order.orderId}"></td>
      <td th:text="${order.branch}"></td>
      <td th:text="${order.requesterId}"></td>
      <td th:text="${order.requesterName}"></td>
      <td th:text="${order.status}"></td>
      <td th:text="${#temporals.format(order.registeredDate != null ? order.registeredDate : now(), 'yyyy-MM-dd')}"></td>
      <td th:text="${#temporals.format(order.lastModified != null ? order.lastModified : now(), 'yyyy-MM-dd')}"></td>
      <td th:text="${order.modifiedBy}"></td>
    </tr>
    </tbody>




  </table>

</div>



<!-- êµ¬ë§¤ ë°œì£¼ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addPurchaseOrderModal" tabindex="-1" aria-labelledby="addPurchaseOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 95%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPurchaseOrderModalLabel">êµ¬ë§¤ ë°œì£¼ ì¶”ê°€</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- ì™¼ìª½: ë°œì£¼ í’ˆëª© í…Œì´ë¸” -->
          <div class="col-md-8">
            <table class="table table-bordered table-striped">
              <thead class="table-dark">
              <tr>
                <th>No</th>
                <th>í’ˆëª©ë²ˆí˜¸</th>
                <th>ìƒí’ˆëª…</th>
                <th>ê°€ê²©</th>
                <th>ë‹¨ìœ„</th>
                <th>ìµœì†Œ ë°œì£¼ëŸ‰</th>
                <th>ìµœëŒ€ ë°œì£¼ëŸ‰</th>
                <th>ë°œì£¼ìˆ˜ëŸ‰</th>
                <th>ì…ê³ ì˜ˆì •ì¼</th>
                <th>ì„ íƒ</th>
              </tr>
              </thead>
              <tbody id="productTableBody">
              <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë°ì´í„° ì¶”ê°€ -->
              </tbody>
            </table>
          </div>

          <!-- ì˜¤ë¥¸ìª½: ë°œì£¼ ì •ë³´ -->
          <div class="col-md-4">
            <div class="border p-3 bg-light rounded">
              <h5 class="mb-3">ë°œì£¼ ì •ë³´</h5>
              <div class="mb-2">
                <label class="form-label">ì§€ì </label>
                <input type="text" id="branchInfo" class="form-control" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">ë°œì£¼ë²ˆí˜¸</label>
                <input type="text" id="orderId" class="form-control" >


              </div>
              <div class="mb-2">
                <label class="form-label">ì´ ìˆ˜ëŸ‰</label>
                <input type="text" id="totalQuantity" class="form-control" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">ì´ ê°€ê²©</label>
                <input type="text" id="totalPrice" class="form-control" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-end">
        <button type="button" class="btn btn-success btn-lg square-button" onclick="submitOrder()">ë°œì£¼</button>
        <button type="button" class="btn btn-secondary btn-lg square-button" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>




<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProductModalLabel">í’ˆëª© ìˆ˜ì •</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editProductForm" th:action="@{/product_master/update}" method="post">
        <div class="modal-body">
          <input type="hidden" id="editMasterId" name="masterId">

          <div class="mb-3">
            <label for="editProductType" class="form-label">í’ˆëª©ìœ í˜•</label>
            <select class="form-select" id="editProductType" name="productType">
              <option value="BE">BE</option>
              <option value="SN">SN</option>
              <option value="TO">TO</option>
              <option value="AL">AL</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editProductCode" class="form-label">í’ˆëª©ì½”ë“œ</label>
            <input type="text" id="editProductCode" name="productCode" class="form-control" required oninput="checkEditProductCode()">
            <div id="editProductCodeMessage" class="text-danger" style="display: none;">ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í’ˆëª©ì½”ë“œì…ë‹ˆë‹¤.</div>
          </div>

          <div class="mb-3">
            <label for="editProductName" class="form-label">í’ˆëª©ëª…</label>
            <input type="text" id="editProductName" name="productName" class="form-control" required oninput="checkEditProductName()">
            <div id="editProductNameMessage" class="text-danger" style="display: none;">ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í’ˆëª©ëª…ì…ë‹ˆë‹¤.</div>
          </div>
          <div class="mb-3">
            <label for="editPrice" class="form-label">ê°€ê²©</label>
            <input type="number" id="editPrice" name="price" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="editUnit" class="form-label">ë‹¨ìœ„</label>
            <input type="text" id="editUnit" name="unit" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">ì €ì¥</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    loadUserInfo(); // ë¡œê·¸ì¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    loadProductData(); // ìƒí’ˆ ë°ì´í„° ë¡œë“œ

    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ë°œì£¼ë²ˆí˜¸ ìë™ ìƒì„±
    document.getElementById("addPurchaseOrderModal").addEventListener("show.bs.modal", function () {
      let orderIdField = document.getElementById("orderId");

      if (!orderIdField || orderIdField.value.trim() === "") {
        generateOrderIdForModal();
      } else {
        console.log("ê¸°ì¡´ ë°œì£¼ë²ˆí˜¸ ìœ ì§€:", orderIdField.value);
      }
    });
  });
  // ğŸ”¥ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  function loadUserInfo() {
    fetch('/user/info')
            .then(response => response.json())
            .then(user => {
              console.log("ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ:", user);

              let branchField = document.getElementById("branchInfo");
              if (branchField) {
                if (user.branch && user.branch.trim() !== "") {
                  branchField.value = user.branch;
                  console.log("ì„¤ì •ëœ ì§€ì  ì •ë³´:", user.branch);
                } else {
                  console.error("ì˜¤ë¥˜: ì‚¬ìš©ì ì§€ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
              } else {
                console.error("ì˜¤ë¥˜: branchInfo í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }
            })
            .catch(error => console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
  }


  // ë°œì£¼ë²ˆí˜¸ ìƒì„±
  function generateOrderIdForModal() {
    fetch('/purchase_order/generateOrderId')
            .then(response => response.json())
            .then(data => {
              let modalOrderIdField = document.querySelector("#addPurchaseOrderModal #orderId"); // ëª¨ë‹¬ ë‚´ë¶€ì˜ orderId ì„ íƒ
              if (modalOrderIdField) {
                modalOrderIdField.value = data.orderId;
                modalOrderIdField.dispatchEvent(new Event('change'));  // ê°’ ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ
                console.log(" ìƒì„±ëœ ë°œì£¼ë²ˆí˜¸:", data.orderId);
                console.log("ì„¤ì •ëœ orderId ê°’ (ëª¨ë‹¬):", modalOrderIdField.value);
              } else {
                console.error("ì˜¤ë¥˜: ëª¨ë‹¬ ë‚´ orderId ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }
            })
            .catch(error => console.error("ëª¨ë‹¬ ë°œì£¼ë²ˆí˜¸ ìƒì„± ì˜¤ë¥˜:", error));
  }





  // ìƒí’ˆ ë°ì´í„° ë¡œë“œ ë° UIì— í‘œì‹œ
  function loadProductData() {
    fetch('/product_master/getAll')
            .then(response => response.json())
            .then(data => {
              console.log("ìƒí’ˆ ë°ì´í„° ì‘ë‹µ:", data); // API ì‘ë‹µ í™•ì¸ìš© ë¡œê·¸ ì¶”ê°€

              let tableBody = document.getElementById("productTableBody");
              tableBody.innerHTML = ""; // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”

              if (!data || data.length === 0) {
                console.warn("âš  ìƒí’ˆ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
                tableBody.innerHTML = "<tr><td colspan='10'>ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                return;
              }

              data.forEach((product, index) => {
                let today = new Date();
                today.setDate(today.getDate() + 2);
                let expectedDate = today.toISOString().split("T")[0];

                let row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${product.productCode}</td>
                    <td>${product.productName}</td>
                    <td>${product.price.toLocaleString()}ì›</td>
                    <td>${product.unit}</td>
                    <td>0</td>
                    <td>20</td>
                    <td>
                        <input type="number" class="form-control order-quantity" min="0" max="20" value="0"
                               data-product-code="${product.productCode}" oninput="updateTotalValues()"/>
                    </td>
                    <td>${expectedDate}</td>
                    <td><input type="checkbox" class="order-checkbox" data-product-code="${product.productCode}"></td>
                `;
                tableBody.appendChild(row);
              });

              console.log("ìƒí’ˆ ëª©ë¡ì´ í…Œì´ë¸”ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€
            })
            .catch(error => console.error("ìƒí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
  }


  // ì´ìˆ˜ëŸ‰ ë° ì´ê°€ê²© ìë™ ê³„ì‚°
  function updateTotalValues() {
    let totalQuantity = 0;
    let totalPrice = 0;

    document.querySelectorAll(".order-quantity").forEach(input => {
      let quantity = parseInt(input.value) || 0;
      let price = parseInt(input.closest("tr").cells[3].textContent.replace(/,/g, "").replace("ì›", "")) || 0;

      totalQuantity += quantity;
      totalPrice += quantity * price;
    });

    // "êµ¬ë§¤ ë°œì£¼ ì¶”ê°€" ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§Œ ë°œì£¼ë²ˆí˜¸ ìë™ ìƒì„±
    document.getElementById("addPurchaseOrderModal").addEventListener("show.bs.modal", function () {
      let orderIdField = document.querySelector("#addPurchaseOrderModal #orderId");

      // ê¸°ì¡´ ë°œì£¼ë²ˆí˜¸ê°€ ì—†ì„ ë•Œë§Œ ìë™ ìƒì„±
      if (!orderIdField.value || orderIdField.value.trim() === "") {
        generateOrderId();
      }
    });


    document.getElementById("totalQuantity").value = totalQuantity;
    document.getElementById("totalPrice").value = totalPrice.toLocaleString() + "ì›";
  }

  // ë°œì£¼ ìš”ì²­ ì „ì†¡
  function submitOrder() {
    let branchField = document.getElementById("branchInfo");
    let branchValue = branchField ? branchField.value.trim() : "";
    let orderIdField = document.querySelector("#addPurchaseOrderModal #orderId");
    let orderIdValue = orderIdField ? orderIdField.value.trim() : "";

    console.log("UIì—ì„œ ê°€ì ¸ì˜¨ ì§€ì ëª…:", branchValue);
    console.log("í˜„ì¬ ë°œì£¼ë²ˆí˜¸:", orderIdValue);

    if (!branchValue || branchValue === "") {
      alert("ì§€ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
      console.error("ì˜¤ë¥˜: branch ê°’ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ.");
      return;
    }

    if (!orderIdValue || orderIdValue.trim() === "") {
      alert("ë°œì£¼ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      console.error("ì˜¤ë¥˜: orderIdê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ.");
      return;
    }

    let orderData = {
      orderId: orderIdValue,
      branch: branchValue,
      items: [...document.querySelectorAll("#productTableBody tr")].map(row => {
        let checkbox = row.cells[9].querySelector(".order-checkbox");
        if (checkbox.checked) {
          return {
            productCode: row.cells[1].textContent.trim(),
            productName: row.cells[2].textContent.trim(),
            price: parseInt(row.cells[3].textContent.replace(/,/g, "").replace("ì›", "")),
            unit: row.cells[4].textContent.trim(),
            orderQuantity: parseInt(row.cells[7].querySelector("input").value),
            expectedDate: row.cells[8].textContent.trim()
          };
        }
      }).filter(item => item !== undefined)
    };

    console.log("ì„œë²„ë¡œ ì „ì†¡í•  ë°œì£¼ ë°ì´í„°:", JSON.stringify(orderData, null, 2));

    fetch('/purchase_order/add', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(orderData)
    })
            .then(response => response.json())
            .then(result => {
              console.log("ì„œë²„ ì‘ë‹µ:", result);
              alert(result.message);
              let modal = bootstrap.Modal.getInstance(document.getElementById("addPurchaseOrderModal"));
              modal.hide();
            })
            .catch(error => {
              console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
              alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            });
  }

  // ë°œì£¼ ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ ë¶„ë¦¬
  // function sendOrderData(orderId, branch) {
  //   let orderData = {
  //     orderId: orderId,
  //     branch: branch || "ë³¸ì‚¬",  // ê¸°ë³¸ê°’ ì„¤ì •
  //     items: [...document.querySelectorAll("#productTableBody tr")].map(row => {
  //       let checkbox = row.cells[9].querySelector(".order-checkbox");
  //       if (checkbox.checked) {
  //         return {
  //           productCode: row.cells[1].textContent.trim(),
  //           productName: row.cells[2].textContent.trim(),
  //           price: parseInt(row.cells[3].textContent.replace(/,/g, "").replace("ì›", "")),
  //           unit: row.cells[4].textContent.trim(),
  //           orderQuantity: parseInt(row.cells[7].querySelector("input").value),
  //           expectedDate: row.cells[8].textContent.trim()
  //         };
  //       }
  //     }).filter(item => item !== undefined)
  //   };
  //
  //   console.log("ì „ì†¡í•  ë°œì£¼ ë°ì´í„°:", JSON.stringify(orderData, null, 2));
  //
  //   fetch('/purchase_order/add', {
  //     method: "POST",
  //     headers: { "Content-Type": "application/json" },
  //     body: JSON.stringify(orderData)
  //   })
  //           .then(response => response.json())
  //           .then(result => {
  //             console.log("ì„œë²„ ì‘ë‹µ:", result);
  //             alert(result.message);
  //             let modal = bootstrap.Modal.getInstance(document.getElementById("addPurchaseOrderModal"));
  //             modal.hide();
  //           })
  //           .catch(error => {
  //             console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
  //             alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
  //           });
  // }





</script>


</body>
</html>
