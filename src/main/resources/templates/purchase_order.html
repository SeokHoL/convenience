<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>êµ¬ë§¤ ë°œì£¼ ê´€ë¦¬</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background-color: #f4f6f9;
    }

    .top-bar {
      background-color: #007bff;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logout-btn {
      background-color: white;
      border: none;
      color: #007bff;
      padding: 5px 15px;
      font-size: 1rem;
      border-radius: 5px;
      text-decoration: none;
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .logout-btn:hover {
      background-color: #e3f2fd;
      color: #0056b3;
      text-decoration: none;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .table {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .table th {
      background-color: #007bff;
      color: white;
    }

    .btn-primary,
    .btn-success {
      border-radius: 20px;
    }

    th, td {
      text-align: center; /* í…ìŠ¤íŠ¸ ë° ì²´í¬ë°•ìŠ¤ ì¤‘ì•™ ì •ë ¬ */
      vertical-align: middle;
    }

    .btn-success-custom {
      background-color: #28a745;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .btn-success-custom:hover {
      background-color: #218838;
    }

    .btn-warning-custom {
      background-color: #ffc107;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .btn-warning-custom:hover {
      background-color: #e0a800;
    }
  </style>
</head>
<body>
<div class="top-bar">
  <span>êµ¬ë§¤ ë°œì£¼ ê´€ë¦¬</span>
  <div>
    <a href="/main" class="text-white text-decoration-none me-3">í™ˆ</a>
    <a href="/logout" class="text-white text-decoration-none">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>

<div class="container mt-4">
  <div class="form-container">
    <h3 class="mb-4">êµ¬ë§¤ ë°œì£¼ ê²€ìƒ‰</h3>
    <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶”ê°€ -->
    <div th:if="${error}" class="alert alert-danger" role="alert">
      <span th:text="${error}"></span>
    </div>
    <form id="searchForm" th:action="@{/purchase_order/search}" method="post">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="branch" class="form-label">ì§€ì </label>
          <select class="form-select" id="branch" name="branch">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ë³¸ì‚¬">ë³¸ì‚¬</option>
            <option value="ì•ˆì–‘">ì•ˆì–‘</option>
            <option value="ì²­ì£¼">ì²­ì£¼</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="orderId" class="form-label">ë°œì£¼ë²ˆí˜¸</label>
          <input type="text" id="orderId" name="orderId" class="form-control" placeholder="ë°œì£¼ë²ˆí˜¸">


        </div>
        <div class="col-md-3">
          <label for="requesterName" class="form-label">ì‚¬ìš©ìëª…</label>
          <input type="text" id="requesterName" name="requesterName" class="form-control" placeholder="ì‚¬ìš©ìëª…">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">ì¡°íšŒ</button>
        </div>
      </div>
    </form>
  </div>

  <div class="text-end mb-3">
    <button class="btn btn-success-custom" data-bs-toggle="modal" data-bs-target="#addPurchaseOrderModal">ì¶”ê°€</button>
    <button class="btn btn-warning-custom" onclick="editSelected()">ìˆ˜ì •</button>
    <button class="btn btn-danger" onclick="deleteSelected()">ì‚­ì œ</button>
  </div>


  <table class="table table-bordered table-hover mt-4">
    <thead>
      <tr>
        <th>ì„ íƒ</th>
        <th>ë°œì£¼ë²ˆí˜¸</th>
        <th>ì§€ì ëª…</th>
        <th>ë°œì£¼ì ID</th>
        <th>ë°œì£¼ì ì´ë¦„</th>
        <th>ìƒíƒœ</th>
        <th>ë“±ë¡ì¼ì</th>
        <th>ìˆ˜ì •ì¼ì</th>
        <th>ìˆ˜ì •ì</th>
      </tr>
      </thead>
    <tbody>
    <tr th:if="${purchaseOrders != null and not #lists.isEmpty(purchaseOrders)}" th:each="order : ${purchaseOrders}">
      <td><input type="checkbox" class="rowCheckbox" th:value="${order.orderId}"></td>
      <td th:text="${order.orderId}"></td>
      <td th:text="${order.branch}"></td>
      <td th:text="${order.requesterId}"></td>
      <td th:text="${order.requesterName}"></td>
      <td th:text="${order.status}"></td>
      <td th:text="${#temporals.format(order.registeredDate != null ? order.registeredDate : now(), 'yyyy-MM-dd')}"></td>
      <td th:text="${#temporals.format(order.lastModified != null ? order.lastModified : now(), 'yyyy-MM-dd')}"></td>
      <td th:text="${order.modifiedBy}"></td>
    </tr>
    </tbody>




  </table>

</div>



<!-- êµ¬ë§¤ ë°œì£¼ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addPurchaseOrderModal" tabindex="-1" aria-labelledby="addPurchaseOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPurchaseOrderModalLabel">êµ¬ë§¤ ë°œì£¼ ì¶”ê°€</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- ì™¼ìª½: ë°œì£¼ í’ˆëª© í…Œì´ë¸” -->
          <div class="col-md-8">
            <table class="table table-bordered table-striped">
              <thead class="table-dark">
              <tr>
                <th>No</th>
                <th>í’ˆëª©ë²ˆí˜¸</th>
                <th>ìƒí’ˆëª…</th>
                <th>ê°€ê²©</th>
                <th>ë‹¨ìœ„</th>
                <th>ìµœì†Œ ë°œì£¼ëŸ‰</th>
                <th>ìµœëŒ€ ë°œì£¼ëŸ‰</th>
                <th>ë°œì£¼ìˆ˜ëŸ‰</th>
                <th>ì…ê³ ì˜ˆì •ì¼</th>
              </tr>
              </thead>
              <tbody id="productTableBody">
              <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë°ì´í„° ì¶”ê°€ -->
              </tbody>
            </table>
          </div>

          <!-- ì˜¤ë¥¸ìª½: ë°œì£¼ ì •ë³´ -->
          <div class="col-md-4">
            <div class="border p-3 bg-light rounded">
              <h5 class="mb-3">ë°œì£¼ ì •ë³´</h5>
              <div class="mb-2">
                <label class="form-label">ì§€ì </label>
                <input type="text" id="branchInfo" class="form-control" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">ë°œì£¼ë²ˆí˜¸</label>
                <input type="text" id="orderId" class="form-control" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">ì´ ìˆ˜ëŸ‰</label>
                <input type="text" id="totalQuantity" class="form-control" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">ì´ ê°€ê²©</label>
                <input type="text" id="totalPrice" class="form-control" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-end">
        <button type="button" class="btn btn-success" onclick="submitOrder()">ë°œì£¼</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>


<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProductModalLabel">í’ˆëª© ìˆ˜ì •</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editProductForm" th:action="@{/product_master/update}" method="post">
        <div class="modal-body">
          <input type="hidden" id="editMasterId" name="masterId">

          <div class="mb-3">
            <label for="editProductType" class="form-label">í’ˆëª©ìœ í˜•</label>
            <select class="form-select" id="editProductType" name="productType">
              <option value="BE">BE</option>
              <option value="SN">SN</option>
              <option value="TO">TO</option>
              <option value="AL">AL</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editProductCode" class="form-label">í’ˆëª©ì½”ë“œ</label>
            <input type="text" id="editProductCode" name="productCode" class="form-control" required oninput="checkEditProductCode()">
            <div id="editProductCodeMessage" class="text-danger" style="display: none;">ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í’ˆëª©ì½”ë“œì…ë‹ˆë‹¤.</div>
          </div>

          <div class="mb-3">
            <label for="editProductName" class="form-label">í’ˆëª©ëª…</label>
            <input type="text" id="editProductName" name="productName" class="form-control" required oninput="checkEditProductName()">
            <div id="editProductNameMessage" class="text-danger" style="display: none;">ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í’ˆëª©ëª…ì…ë‹ˆë‹¤.</div>
          </div>
          <div class="mb-3">
            <label for="editPrice" class="form-label">ê°€ê²©</label>
            <input type="number" id="editPrice" name="price" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="editUnit" class="form-label">ë‹¨ìœ„</label>
            <input type="text" id="editUnit" name="unit" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">ì €ì¥</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    loadUserInfo(); // ë¡œê·¸ì¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    loadProductData(); // ìƒí’ˆ ë°ì´í„° ë¡œë“œ

    // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•  ìˆ˜ ìˆë„ë¡ ë°œì£¼ë²ˆí˜¸ ìë™ ìƒì„± ë§‰ê¸°
    let orderIdField = document.getElementById("orderId");
    if (!orderIdField || orderIdField.value.trim() !== "") {
      return;  // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ëŠ” ê²½ìš° ìë™ ìƒì„± ë°©ì§€
    }
  });

  // ğŸ”¥ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  function loadUserInfo() {
    fetch('/user/info')
            .then(response => response.json())
            .then(user => {
              console.log("ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ:", user);
              let branchField = document.getElementById("branchInfo");
              if (branchField) {
                branchField.value = user.branch || "ì§€ì  ì •ë³´ ì—†ìŒ";
              }
            })
            .catch(error => console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
  }


  // ë°œì£¼ë²ˆí˜¸ ìƒì„±
  function generateOrderId() {
    fetch('/purchase_order/generateOrderId')
            .then(response => {
              if (!response.ok) throw new Error("ë°œì£¼ë²ˆí˜¸ ìƒì„± ì‹¤íŒ¨");
              return response.json();
            })
            .then(data => {
              console.log("âœ… ìƒì„±ëœ ë°œì£¼ë²ˆí˜¸:", data.orderId);
              document.getElementById("orderId").value = data.orderId;
            })
            .catch(error => console.error("âŒ ë°œì£¼ë²ˆí˜¸ ìƒì„± ì˜¤ë¥˜:", error));
  }



  // ğŸ”¥ ìƒí’ˆ ë°ì´í„° ë¡œë“œ ë° UIì— í‘œì‹œ
  function loadProductData() {
    fetch('/product_master/getAll')
            .then(response => response.json())
            .then(data => {
              let tableBody = document.getElementById("productTableBody");
              tableBody.innerHTML = ""; // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”

              data.forEach((product, index) => {
                let today = new Date();
                today.setDate(today.getDate() + 2); // ì…ê³  ì˜ˆì •ì¼ +2ì¼
                let expectedDate = today.toISOString().split("T")[0];

                let row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${product.productCode}</td>
                    <td>${product.productName}</td>
                    <td>${product.price.toLocaleString()}ì›</td>
                    <td>${product.unit}</td>
                    <td>1</td>
                    <td>20</td>
                    <td>
                        <input type="number" class="form-control order-quantity" min="1" max="20" value="1"
                               data-product-code="${product.productCode}" oninput="updateTotalValues()"/>
                    </td>
                    <td>${expectedDate}</td>
                `;
                tableBody.appendChild(row);
              });
            })
            .catch(error => console.error('ìƒí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
  }


  // ğŸ”¥ ì´ìˆ˜ëŸ‰ ë° ì´ê°€ê²© ìë™ ê³„ì‚°
  function updateTotalValues() {
    let totalQuantity = 0;
    let totalPrice = 0;

    document.querySelectorAll(".order-quantity").forEach(input => {
      let quantity = parseInt(input.value) || 0;
      let price = parseInt(input.closest("tr").cells[3].textContent.replace(/,/g, "").replace("ì›", "")) || 0;

      totalQuantity += quantity;
      totalPrice += quantity * price;
    });

    document.getElementById("totalQuantity").value = totalQuantity;
    document.getElementById("totalPrice").value = totalPrice.toLocaleString() + "ì›";
  }

  // ğŸ”¥ ë°œì£¼ ìš”ì²­ ì „ì†¡
  function submitOrder() {
    let branchValue = document.getElementById("branchInfo").value.trim();
    if (!branchValue) {
      alert("ì§€ì  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    let orderItems = [];
    document.querySelectorAll("#productTableBody tr").forEach(row => {
      let productCode = row.cells[1].textContent.trim();
      let productName = row.cells[2].textContent.trim();
      let price = parseInt(row.cells[3].textContent.replace(/,/g, "").replace("ì›", ""));
      let unit = row.cells[4].textContent.trim();
      let orderQuantity = parseInt(row.cells[7].querySelector("input").value);

      let expectedDate = new Date();
      expectedDate.setDate(expectedDate.getDate() + 2);
      expectedDate = expectedDate.toISOString().split("T")[0];

      orderItems.push({
        branch: branchValue,
        productCode: productCode,
        productName: productName,
        price: price,
        unit: unit,
        minOrder: 1,
        maxOrder: 20,
        orderQuantity: orderQuantity,
        expectedDate: expectedDate
      });
    });

    fetch(`/purchase_order/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ branch: branchValue })  // bodyë¡œ ë°ì´í„°ë¥¼ ì „ë‹¬í•´ì•¼ í•¨
    })
            .then(response => response.json())
            .then(data => {
              let orderId = data.orderId;
              let orderData = {
                orderId: orderId,
                branch: branchValue,
                items: orderItems
              };


              return fetch('/purchase_order/add', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData)
              });
            })
            .then(response => response.json())
            .then(result => alert(result.message))
            .catch(error => alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message));
  }


</script>


</body>
</html>
